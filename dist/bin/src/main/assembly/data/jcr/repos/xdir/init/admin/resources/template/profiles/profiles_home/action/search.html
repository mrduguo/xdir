<@page_overview_title/>
<form method="get" action="${pageUrl}">
	<input type="hidden" name="action" value="search"/>
	<input type="text" name="query" value="${getStringParameter("query")}"/>
	<button type="submit" class="button">Search Profiles</button>
</form>
<#assign groovy = "org.duguo.xdir.core.internal.template.freemarker.GroovyDirective"?new()>
<h3>Results</h3>
<@groovy>
	def ouputstring="<table class=\"sortable\"><thead><tr><th>User ID</th><th>Display Name</th></tr></thead><tbody>"
	statusStr=""
	queryStr="""select * from [nt:base] WHERE _type='user' AND (CONTAINS(_user_id,'*${getStringParameter("query")}*') OR CONTAINS(_title,'*${getStringParameter("query")}*'))"""
	nodeIterator = model.getSession().getWorkspace().getQueryManager().createQuery(queryStr, "JCR-SQL2").execute().getNodes();
	long timespend=System.currentTimeMillis();
	int maxRecord=100;
	int i=0;
	while(nodeIterator.hasNext()){
		i++;
		if(i>maxRecord){
			timespend=System.currentTimeMillis()-timespend;
			statusStr="<div>Found more than $maxRecord users in $timespend milliseconds</div>"
			break;
		}
		accountNode=nodeIterator.nextNode()
		nodePath=accountNode.getPath()
		userId=accountNode.getProperty("_user_id").getString()
		ouputstring="$ouputstring<tr><td>"+userId+"</td><td><a href=\"${pagePath}/"+userId+"/index${format}\">"+accountNode.getProperty("_title").getString()+"</a></td></tr>"
	}
	ouputstring="$ouputstring</tbody></table>"
	if(i==0){
		timespend=System.currentTimeMillis()-timespend;
		statusStr="<div>Found 0 users in $timespend milliseconds</div>"
		ouputstring=""
	}else if(i<=maxRecord){
		timespend=System.currentTimeMillis()-timespend;
		statusStr="<div>Found $i users in $timespend milliseconds</div>"
	}
	return statusStr+ouputstring
</@groovy>
