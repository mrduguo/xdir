<@page_overview_title/>
<#assign groovy = "org.xdir.platform.core.internal.template.freemarker.GroovyDirective"?new()>
<@groovy>

import org.expressme.openid.*;

System.setProperty("debug","true")

        OpenIdManager manager = new OpenIdManager();
        manager.setReturnTo(model.pagePath+".html");
        manager.setRealm("https://127.0.0.1:8443");
        manager.setTimeOut(10000);
        
        ShortName shortName=new ShortName();
        shortName.getUrlMap().put("google", "https://www.google.com/accounts/o8/id");
        shortName.getUrlMap().put("yahoo", "http://open.login.yahooapis.com/openid20/www.yahoo.com/xrds");
        shortName.getAliasMap().put("yahoo", "ax");
        manager.setShortName(shortName);
        
        Map<String, String> requiredFields=new HashMap<String, String>();
        requiredFields.put("email","http://axschema.org/contact/email");
        requiredFields.put("fullname","http://axschema.org/namePerson");
        requiredFields.put("language","http://axschema.org/pref/language");
        requiredFields.put("firstname","http://axschema.org/namePerson/first");
        requiredFields.put("lastname","http://axschema.org/namePerson/last");
        requiredFields.put("gender","http://axschema.org/person/gender");
        requiredFields.put("image","http://axschema.org/media/image/default");
        requiredFields.put("timezone","http://axschema.org/pref/timezone");
        manager.setRequiredFields(requiredFields);
        
        
        Endpoint endpoint = manager.lookupEndpoint(model.getStringParameter("identity"));
        //Endpoint endpoint = manager.lookupEndpoint("yahoo");
        System.out.println(endpoint);
        Association association = manager.lookupAssociation(endpoint);
        System.out.println(association);
        String authUrl = manager.getAuthenticationUrl(endpoint, association);
        
        System.out.println(authUrl);
        
        model.request.getSession(true).setAttribute("tokenSecret",association.getMacKey())
        
        
        
        model.response.sendRedirect(authUrl);
	return authUrl
	//return model.pagePath+"/callback.html"
</@groovy>
<#stop "redirected to login"/>