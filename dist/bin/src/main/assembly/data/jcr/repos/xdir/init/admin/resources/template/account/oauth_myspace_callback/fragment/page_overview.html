<@page_overview_title/>
<#assign groovy = "org.xdir.platform.core.internal.template.freemarker.GroovyDirective"?new()>
<@groovy>

import oauth.signpost.OAuth;
import oauth.signpost.OAuthConsumer;
import oauth.signpost.OAuthProvider;
import oauth.signpost.basic.DefaultOAuthConsumer;
import oauth.signpost.basic.DefaultOAuthProvider;
import org.xdir.platform.api.security.Role;
import org.xdir.platform.util.codec.IdUtil;

import javax.xml.parsers.DocumentBuilderFactory

System.setProperty("debug","true")


    	OAuthConsumer consumer = new DefaultOAuthConsumer("d179416d9f6541bd8bfc7243dc609f1a","2910dcdd583f471b89ed37525728925cc5cab1f6dc694b918faa731e212efc56");


        scope="http://www.google.com/m8/feeds/";
        scope = model.pagePath;
        
        OAuthProvider provider = new DefaultOAuthProvider(
        		"http://api.myspace.com/request_token",
                "http://api.myspace.com/access_token",
                "http://api.myspace.com/authorize");
                
        //provider.retrieveAccessToken(consumer, );
        session=model.request.getSession(false)
        if(session==null){
        	return "session expired";
        }
        String oauth_token=model.getStringParameter("oauth_token");
        String tokenSecret=session.getAttribute("tokenSecret")
        consumer.setTokenWithSecret(oauth_token, tokenSecret);
        provider.setOAuth10a(true)
        provider.retrieveAccessToken(consumer, model.getStringParameter("oauth_verifier"));
        
        
        URL url = new URL("http://api.myspace.com/v1/user?detailtype=extended");
        HttpURLConnection request = (HttpURLConnection) url.openConnection();
        // sign the request
        consumer.sign(request);
        // send the request
        request.connect();
        // response status should be 200 OK
        int statusCode = request.getResponseCode();
        
def builder     = DocumentBuilderFactory.newInstance().newDocumentBuilder()
def records      = new XmlParser().parse(request.getInputStream())
//http://developerwiki.myspace.com/index.php?title=MySpace_API:_User

        def userName=records.userid.text();
        
        
        
        url = new URL("http://api.myspace.com/v1/users/"+userName+"/profile?detailtype=extended");
        request = (HttpURLConnection) url.openConnection();
        // sign the request
        consumer.sign(request);
        // send the request
        request.connect();

        statusCode = request.getResponseCode();
        System.out.println("status:"+statusCode);
        
        
builder     = DocumentBuilderFactory.newInstance().newDocumentBuilder()
records      = new XmlParser().parse(request.getInputStream())

        
        def writer = new StringWriter()
new XmlNodePrinter(new PrintWriter(writer)).print(records)
 result = writer.toString()
        System.out.println("records:\n"+result);
        
        
        def userDisplayName=records.displayname.text();
        def userLocation=records.profile.city.text();
        def userIcon=records.imageuri.text();
        def userDescription=records.profile.aboutme.text();
        def userUrl=records.weburi.text();
        def userTimeZone=records.profile.country.text();
        
        
        def result="";
        result="$result<div>"+userDisplayName+"</div>"
        result="$result<div><img src=\""+userIcon+"\"/></div>"
        result="$result<div>"+userName+"</div>"
        result="$result<div>"+userLocation+"</div>"
        result="$result<div>"+userDescription+"</div>"
        result="$result<div>"+userUrl+"</div>"
        result="$result<div>"+userTimeZone+"</div>"
        
        def loginName="myspace:"+userName;
        loginNode=model.app.loadLogin(loginName);
        if(loginNode!=null){
            session.setAttribute("loginName",loginName);
        	user=model.app.security.login(model)
        	result="$result<div>logged in</div>"
        }else{
        	def userId=userUrl;
	        userId=userId.substring(userId.indexOf("/",10)+1);
	        userId=IdUtil.normalizePathId(userId);
        	
        	
        	userNode=model.app.loadUser(userId);
        	if(userNode!=null){
        		userId=userId+"_"+System.currentTimeMillis();
        	}
        	def userAttributes =new HashMap();
        	
        	userAttributes.put("_title",userDisplayName);
        	userAttributes.put("_source", "myspace");
        	userAttributes.put("_role", Role.USER+"");
        	
        	
        	userAttributes.put("logins/myspace_"+userName+"/_user_name", loginName);
        	userAttributes.put("logins/myspace_"+userName+"/_type", "login");
        	userAttributes.put("profile/_icon", userIcon);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/180_url", userUrl);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/_time_zone", userTimeZone);
        	userAttributes.put("profile/_overview", userDescription);
        	userAttributes.put("logins/myspace_"+userName+"/_icon", userIcon);
        	
        	userNode=model.app.createUser(userId,userAttributes);
        	if(userNode!=null){
        		result="$result<div>user created <a href=\"../../index"+model.format+"\">OK</a></div>"
            	session.setAttribute("loginName",loginName);
        		user=model.app.security.login(model)
        	}else{
        		result="$result<div>user create failed</div>"
        	}
        }
        System.out.println("consumer.getToken():"+consumer.getToken());
        System.out.println("consumer.getTokenSecret():"+consumer.getTokenSecret());

	return result;
	//return consumer.getToken()+":"+consumer.getTokenSecret()
	//return model.pagePath+"/callback.html"
</@groovy>