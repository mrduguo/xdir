<@page_overview_title/>
<#assign groovy = "org.duguo.xdir.core.internal.template.freemarker.GroovyDirective"?new()>
<@groovy>

import oauth.signpost.OAuth;
import oauth.signpost.OAuthConsumer;
import oauth.signpost.OAuthProvider;
import oauth.signpost.basic.DefaultOAuthConsumer;
import oauth.signpost.basic.DefaultOAuthProvider;
import org.duguo.xdir.spi.security.Role;
import org.duguo.xdir.util.codec.IdUtil;

import javax.xml.parsers.DocumentBuilderFactory

System.setProperty("debug","true")


    	OAuthConsumer consumer = new DefaultOAuthConsumer("6CuRZomIfI08ArO_6xg67sK2aVyhvlTitGrCeFeiML0J8coOeiKXmfzLJqc88Lfd","-0CRzm1w20QjZfwNm5kWW72K_BFhp5L0CGEH1fLlseGIiY_27lJXqFU0R9xlJggK");


        scope="http://www.google.com/m8/feeds/";
        scope = model.pagePath;
        
        OAuthProvider provider = new DefaultOAuthProvider(
        		"https://api.linkedin.com/uas/oauth/requestToken",
                "https://api.linkedin.com/uas/oauth/accessToken",
                "https://api.linkedin.com/uas/oauth/authorize");
                
        
                
        //provider.retrieveAccessToken(consumer, );
        session=model.request.getSession(false)
        if(session==null){
        	return "session expired";
        }
        String oauth_token=model.getStringParameter("oauth_token");
        String tokenSecret=session.getAttribute("tokenSecret")
        consumer.setTokenWithSecret(oauth_token, tokenSecret);
        provider.setOAuth10a(true)
        provider.retrieveAccessToken(consumer, model.getStringParameter("oauth_verifier"));
        
        
        URL url = new URL("http://api.linkedin.com/v1/people/~:public");
        HttpURLConnection request = (HttpURLConnection) url.openConnection();

        // sign the request
        consumer.sign(request);

        // send the request
        request.connect();

        // response status should be 200 OK
        int statusCode = request.getResponseCode();
        System.out.println("status:"+statusCode);
        
        
def builder     = DocumentBuilderFactory.newInstance().newDocumentBuilder()
def records      = new XmlParser().parse(request.getInputStream())

        
        def writer = new StringWriter()
new XmlNodePrinter(new PrintWriter(writer)).print(records)
 result = writer.toString()
        System.out.println("records:\n"+result);

//http://developer.linkedin.com/docs/DOC-1002
//http://developer.linkedin.com/docs/DOC-1061

        def userName=records.id.text();
        def userDisplayName=records."first-name".text()+" "+records."last-name".text();
        def userLocation=records.location.name.text();
        def userIcon=records."picture-url".text();
        def userDescription=records.headline.text();
        def userUrl=records."public-profile-url".text();
        def userTimeZone=records.location.country.code.text();
        
        def result="";
        result="$result<div>"+userDisplayName+"</div>"
        result="$result<div><img src=\""+userIcon+"\"/></div>"
        result="$result<div>"+userName+"</div>"
        result="$result<div>"+userLocation+"</div>"
        result="$result<div>"+userDescription+"</div>"
        result="$result<div>"+userUrl+"</div>"
        result="$result<div>"+userTimeZone+"</div>"
        
        def loginName="linkedin:"+userName;
        loginNode=model.app.loadLogin(loginName);
        if(loginNode!=null){
            session.setAttribute("loginName",loginName);
        	user=model.app.security.login(model)
        	result="$result<div>logged in</div>"
        }else{
        	def userId=userUrl;
	        userId=userId.substring(userId.indexOf("/",10));
	        userId=userId.substring(userId.indexOf("/",2)+1);
	        userId=IdUtil.normalizePathId(userId);
        	
        	
        	userNode=model.app.loadUser(userId);
        	if(userNode!=null){
        		userId=userId+"_"+System.currentTimeMillis();
        	}
        	def userAttributes =new HashMap();
        	
        	userAttributes.put("_title",userDisplayName);
        	userAttributes.put("_source", "linkedin");
        	userAttributes.put("_role", Role.USER+"");
        	
        	
        	userAttributes.put("logins/linkedin_"+userName+"/_user_name", loginName);
        	userAttributes.put("logins/linkedin_"+userName+"/_type", "login");
        	userAttributes.put("profile/_icon", userIcon);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/180_url", userUrl);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/_time_zone", userTimeZone);
        	userAttributes.put("profile/_overview", userDescription);
        	userAttributes.put("logins/linkedin_"+userName+"/_icon", userIcon);
        	
        	userNode=model.app.createUser(userId,userAttributes);
        	if(userNode!=null){
        		result="$result<div>user created <a href=\"../../index"+model.format+"\">OK</a></div>"
            	session.setAttribute("loginName",loginName);
        		user=model.app.security.login(model)
        	}else{
        		result="$result<div>user create failed</div>"
        	}
        }
        System.out.println("consumer.getToken():"+consumer.getToken());
        System.out.println("consumer.getTokenSecret():"+consumer.getTokenSecret());

	return result;
	//return consumer.getToken()+":"+consumer.getTokenSecret()
	//return model.pagePath+"/callback.html"
</@groovy>