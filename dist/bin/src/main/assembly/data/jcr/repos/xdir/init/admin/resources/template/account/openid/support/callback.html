<#assign groovy = "org.duguo.xdir.core.internal.template.freemarker.GroovyDirective"?new()>
<@groovy>

import org.expressme.openid.*;

System.setProperty("debug","true")

        OpenIdManager manager = new OpenIdManager();
        manager.setReturnTo(model.pagePath+".html");
        manager.setRealm("https://127.0.0.1:8443");
        manager.setTimeOut(10000);
        
        ShortName shortName=new ShortName();
        shortName.getUrlMap().put("google", "https://www.google.com/accounts/o8/id");
        shortName.getUrlMap().put("yahoo", "http://open.login.yahooapis.com/openid20/www.yahoo.com/xrds");
        shortName.getAliasMap().put("yahoo", "ax");
        manager.setShortName(shortName);
        
        Map<String, String> requiredFields=new HashMap<String, String>();
        requiredFields.put("email","http://axschema.org/contact/email");
        requiredFields.put("fullname","http://axschema.org/namePerson");
        requiredFields.put("language","http://axschema.org/pref/language");
        requiredFields.put("firstname","http://axschema.org/namePerson/first");
        requiredFields.put("lastname","http://axschema.org/namePerson/last");
        requiredFields.put("gender","http://axschema.org/person/gender");
        requiredFields.put("image","http://axschema.org/media/image/default");
        requiredFields.put("timezone","http://axschema.org/pref/timezone");
        manager.setRequiredFields(requiredFields);
        
        
        //Endpoint endpoint = manager.lookupEndpoint("google");
        Endpoint endpoint = manager.lookupEndpoint(model.getStringParameter("openid.identity"));
        System.out.println(endpoint);
        Association association = manager.lookupAssociation(endpoint);
        System.out.println(association);
        String authUrl = manager.getAuthenticationUrl(endpoint, association);
        
        tokenSecret=model.request.getSession(true).getAttribute("tokenSecret")
        Authentication authentication = manager.getAuthentication(model.request, Base64.decode(tokenSecret), endpoint.getAlias());
        System.out.println(authentication);
        
return "";
        
        def result="";
        result="$result<div>"+userDisplayName+"</div>"
        result="$result<div><img src=\""+userIcon+"\"/></div>"
        result="$result<div>"+userName+"</div>"
        result="$result<div>"+userLocation+"</div>"
        result="$result<div>"+userDescription+"</div>"
        result="$result<div>"+userUrl+"</div>"
        result="$result<div>"+userTimeZone+"</div>"
        
        def loginName="myspace:"+userName;
        loginNode=model.app.loadLogin(loginName);
        if(loginNode!=null){
            session.setAttribute("loginName",loginName);
        	user=model.app.security.login(model)
        	result="$result<div>logged in</div>"
        }else{
        	def userId=userUrl;
	        userId=userId.substring(userId.indexOf("/",10)+1);
	        userId=IdUtil.normalizePathId(userId);
        	
        	
        	userNode=model.app.loadUser(userId);
        	if(userNode!=null){
        		userId=userId+"_"+System.currentTimeMillis();
        	}
        	def userAttributes =new HashMap();
        	
        	userAttributes.put("_title",userDisplayName);
        	userAttributes.put("_source", "myspace");
        	userAttributes.put("_role", Role.USER+"");
        	
        	
        	userAttributes.put("logins/myspace_"+userName+"/_user_name", loginName);
        	userAttributes.put("logins/myspace_"+userName+"/_type", "login");
        	userAttributes.put("profile/_icon", userIcon);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/180_url", userUrl);
        	userAttributes.put("profile/110_location", userLocation);
        	userAttributes.put("profile/_time_zone", userTimeZone);
        	userAttributes.put("profile/_overview", userDescription);
        	userAttributes.put("logins/myspace_"+userName+"/_icon", userIcon);
        	
        	userNode=model.app.createUser(userId,userAttributes);
        	if(userNode!=null){
        		result="$result<div>user created <a href=\"../../index"+model.format+"\">OK</a></div>"
            	session.setAttribute("loginName",loginName);
        		user=model.app.security.login(model)
        	}else{
        		result="$result<div>user create failed</div>"
        	}
        }
        System.out.println("consumer.getToken():"+consumer.getToken());
        System.out.println("consumer.getTokenSecret():"+consumer.getTokenSecret());

	return result;
	//return consumer.getToken()+":"+consumer.getTokenSecret()
	//return model.pagePath+"/callback.html"
</@groovy>