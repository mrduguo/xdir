<@page_overview_title/>
<#assign groovy = "org.duguo.xdir.core.internal.template.freemarker.GroovyDirective"?new()>
<@groovy>

import org.expressme.openid.*;

import org.duguo.xdir.util.codec.IdUtil;
import org.duguo.xdir.spi.security.Role;


json=model.app.security.get("oauthtwitter").retriveUserInfo(model.request);
model.put("json",json);


        userInfo = json.user;
        if(userInfo.identity.isNull()){
        	return "Failed to talk to OAuth provider, please try again later.";
        }

System.setProperty("debug","true")



        
        def userName=userInfo.identity.get();
        def userEmail=userInfo.email.get();
        def userDisplayName=userInfo.fullname.get();
        def userIcon=userInfo.image.get();
        def userTimeZone=userInfo.timezone.get();
        
                
        def result="";
        result="$result<div>"+userDisplayName+"</div>"
        result="$result<div><img src=\""+userIcon+"\"/></div>"
        result="$result<div>"+userName+"</div>"
        result="$result<div>"+userTimeZone+"</div>"
        
        def loginName=userName;
        loginNode=model.app.loadLogin(loginName);
        
        
        session=model.request.getSession(false)
        if(session==null){
        	return "session expired";
        }
        if(loginNode!=null){
            session.setAttribute("loginName",loginName);
        	user=model.app.security.login(model)
        	result="$result<div>logged in</div>"
        }else{
        	def userId=userEmail;
	        def userPath=userEmail.substring(0,userEmail.indexOf("@"));
        	userNode=model.app.loadUser(userId);
        	if(userNode!=null){
        		userId=userId+"_"+System.currentTimeMillis();
        	}
        	def userAttributes =new HashMap();
        	
        	userAttributes.put("_title",userDisplayName);
        	userAttributes.put("_source", "openid");
        	userAttributes.put("_role", Role.USER+"");
        	
        	
        	userAttributes.put("logins/openid_"+userPath+"/_user_name", loginName);
        	userAttributes.put("logins/openid_"+userPath+"/_type", "login");
        	userAttributes.put("logins/openid_"+userPath+"/_icon", userIcon);
        	userAttributes.put("profile/_icon", userIcon);
        	userAttributes.put("profile/_email", userEmail);
        	userAttributes.put("profile/_time_zone", userTimeZone);
        	
        	System.out.println("userid:\n\n\n"+userId);
        	userNode=model.app.createUser(userId,userAttributes);
        	if(userNode!=null){
        		result="$result<div>user created <a href=\"../../../index"+model.format+"\">OK</a></div>"
            	
        		session.setAttribute("loginName",loginName);
        		user=model.app.security.login(model)
        	}else{
        		result="$result<div>user create failed</div>"
        	}
        }

	return result;
	//return consumer.getToken()+":"+consumer.getTokenSecret()
	//return model.pagePath+"/callback.html"
</@groovy>