<#assign groovy = "org.duguo.xdir.core.internal.template.freemarker.GroovyDirective"?new()>
<#macro sql_init>
	import groovy.sql.Sql
	import groovy.sql.GroovyResultSetExtension
	<#if (connection_settings?starts_with("jdbc:"))>
		def sql = Sql.newInstance("${connection_settings}")
	<#elseif (connection_settings?index_of("/")>=0)>
		def sql = Sql.newInstance("jdbc:derby:${connection_settings};create=true")
	<#elseif (connection_settings?index_of("\\")>=0)>
		def sql = Sql.newInstance("jdbc:derby:${connection_settings};create=true")
	<#elseif (app.retriveConnection(model,"${connection_settings}",null,null)??)>
		def sql = new Sql(model.get("connection"))
	<#else>
		return "connection settings isn't recognized"
	</#if>
	model.app.put("connection",sql.connection)
	def ouputstring=""
</#macro>
<#macro sql_destroy>
	model.app.remove("connection")
	sql.connection.close()
	return ouputstring
</#macro>
<#macro sql_execute_result query_name,query_sql>
	try{
		sql.execute(
			<@sql_parse_query_with_params query_sql/>
		)
		ouputstring="$ouputstring<h3>${query_name}</h3><p>$sql.updateCount</p>"
	}catch(Exception ex){
		ouputstring="$ouputstring<h3>${query_name}</h3><p>$ex.message</p>"	
	}	
</#macro>
<#macro sql_query_result query_name,query_sql,pageSize,linkBase>
	ouputstring="$ouputstring<h3>${query_name}</h3>"
	try{		
		query_sql="""${query_sql}"""
		pageDefaultSize=10
		<#include "pagination">
		pageTotal=sql.firstRow(
			"""select count(*) ${query_sql?substring(query_sql?lower_case?index_of(" from "))}"""
	     )[0]
	
			if(pageTotal==0){
			     ouputstring="$ouputstring 0 record"		
			}else if( query_sql.toLowerCase().startsWith("select count(") ){
			     ouputstring="$ouputstring $pageTotal record"		
			}else{
				ouputstring="$ouputstring<table class=\"sortable\"><thead><tr>"
				def resultSet=sql.connection.createStatement().executeQuery(query_sql)
				def resultSetMetaData=resultSet.metaData
				def columnSize=resultSetMetaData.columnCount
				(1..columnSize).each{
				     ouputstring="$ouputstring<th>"+resultSetMetaData.getColumnLabel(it)+"</th>"
				}
				ouputstring="$ouputstring</tr></thead><tbody>"
				if(pageStart!=1){			
						def skip=2
						if(pageStart>pageTotal){
							pageStart=pageTotal-pageSize
						}
						while(resultSet.next() && skip<pageStart){
							skip=skip+1
						}
				}
				def endRecord=pageStart+pageSize
				def currentRecord=pageStart
				while(resultSet.next() && currentRecord<endRecord){
					currentRecord=currentRecord+1
				     ouputstring="$ouputstring<tr>"
					(1..columnSize).each{
					     ouputstring="$ouputstring<td><pre>"+freemarker.template.utility.StringUtil.HTMLEnc(resultSet.getObject(it).toString())+"</pre></td>"
					}
				     ouputstring="$ouputstring</tr>"
				}
				resultSet.close()
				ouputstring=ouputstring+"</tbody></table>"
				<@pagination_links "ouputstring",linkBase+"query="+query_sql?url('ISO-8859-1')+"&start"/>
			}	
	}catch(Exception ex){
		ouputstring="$ouputstring $ex.message"	
	}	
</#macro>
<#macro sql_parse_query_with_params query_sql>
	<#if (query_sql?lower_case?index_of("params:")>0)>
		"""${query_sql?substring(0,query_sql?lower_case?index_of("params:"))}""",
		[<#list query_sql?substring(query_sql?lower_case?index_of("params:")+7)?split(",") as x><#if x_index!=0>,</#if>"${x}"</#list>]
	<#else>
		"""${query_sql}"""
	</#if>
</#macro>
<#macro sql_db_info>
	sqlMetaData=sql.connection.metaData
	ouputstring="$ouputstring<h3>DB Info</h3><table class=\"sortable\">"
	ouputstring=ouputstring+"<tr><th>Database Product Name</th><td> $sqlMetaData.databaseProductName</td></tr>"
	ouputstring=ouputstring+"<tr><th>Database Product Version</th><td> $sqlMetaData.databaseProductVersion</td></tr>"
	ouputstring=ouputstring+"<tr><th>Driver Version</th><td> $sqlMetaData.driverVersion</td></tr>"
	ouputstring=ouputstring+"<tr><th>Driver Name</th><td> $sqlMetaData.driverName</td></tr>"
	ouputstring=ouputstring+"<tr><th>User Name</th><td> $sqlMetaData.userName</td></tr>"
	ouputstring=ouputstring+"<tr><th>URL</th><td> $sqlMetaData.URL</td></tr>"
	ouputstring=ouputstring+"</table>"
</#macro>
<#macro sql_db_table_list>
	ouputstring=ouputstring+"<h3>DB Tables</h3><table class=\"sortable\"><thead><tr><th>Name</th><th>Schema</th></tr></thead><tbody>"
	resultset=new GroovyResultSetExtension(sqlMetaData.getTables(null,null,null,null))
	resultset.eachRow{
		ouputstring=ouputstring+"<tr><td><a href=\"${pageUrl}?action=tableinfo&tablecat=$it.TABLE_CAT&tableschem=$it.TABLE_SCHEM&tablename=$it.TABLE_NAME\">$it.TABLE_NAME</a></td>"
		ouputstring=ouputstring+"<td>$it.TABLE_SCHEM</td></tr>"
	}
	ouputstring=ouputstring+"</tbody></table>"
</#macro>